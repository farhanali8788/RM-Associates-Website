document.addEventListener("DOMContentLoaded", () => {
  const track = document.querySelector(".carousel-track");
  const slides = document.querySelectorAll(".service-card");
  const nextBtn = document.querySelector(".next");
  const prevBtn = document.querySelector(".prev");
  const dotsContainer = document.querySelector(".carousel-dots");

  let index = 1;
  let slideWidth;
  let autoPlayInterval;

  /* CLONE FIRST & LAST */
  const firstClone = slides[0].cloneNode(true);
  const lastClone = slides[slides.length - 1].cloneNode(true);

  firstClone.classList.add("clone");
  lastClone.classList.add("clone");

  track.appendChild(firstClone);
  track.prepend(lastClone);

  const allSlides = document.querySelectorAll(".service-card");

  function setSlideWidth() {
    slideWidth = allSlides[0].offsetWidth + 25;
  }

  setSlideWidth();

  track.style.transform = `translateX(-${slideWidth * index}px)`;

  /* CREATE DOTS */
  slides.forEach((_, i) => {
    const dot = document.createElement("span");
    dot.addEventListener("click", () => moveToRealSlide(i));
    dotsContainer.appendChild(dot);
  });

  const dots = document.querySelectorAll(".carousel-dots span");
  dots[0].classList.add("active");

  function updateDots(realIndex) {
    dots.forEach((d) => d.classList.remove("active"));
    dots[realIndex].classList.add("active");
  }

  /* MOVE REAL SLIDE */
  function moveToRealSlide(i) {
    index = i + 1;
    track.style.transition = "0.5s ease";
    track.style.transform = `translateX(-${slideWidth * index}px)`;
    updateDots(i);
  }

  /* NEXT */
  function nextSlide() {
    index++;
    track.style.transition = "0.5s ease";
    track.style.transform = `translateX(-${slideWidth * index}px)`;
  }

  /* PREV */
  function prevSlide() {
    index--;
    track.style.transition = "0.5s ease";
    track.style.transform = `translateX(-${slideWidth * index}px)`;
  }

  nextBtn.addEventListener("click", nextSlide);
  prevBtn.addEventListener("click", prevSlide);

  /* LOOP FIX */
  track.addEventListener("transitionend", () => {
    if (allSlides[index].classList.contains("clone")) {
      track.style.transition = "none";

      if (index === allSlides.length - 1) {
        index = 1;
      }

      if (index === 0) {
        index = allSlides.length - 2;
      }

      track.style.transform = `translateX(-${slideWidth * index}px)`;

      /* FORCE REFLOW */
      track.offsetHeight;

      /* RE-ENABLE TRANSITION */
      setTimeout(() => {
        track.style.transition = "0.5s ease";
      }, 20);
    }

    updateDots(index - 1);
  });

  /* AUTOPLAY */
  function startAutoPlay() {
    autoPlayInterval = setInterval(nextSlide, 3500);
  }

  function stopAutoPlay() {
    clearInterval(autoPlayInterval);
  }

  startAutoPlay();

  track.addEventListener("mouseenter", stopAutoPlay);
  track.addEventListener("mouseleave", startAutoPlay);

  /* SWIPE */
  let startX = 0;

  track.addEventListener("touchstart", (e) => {
    startX = e.touches[0].clientX;
  });

  track.addEventListener("touchend", (e) => {
    let endX = e.changedTouches[0].clientX;

    if (startX - endX > 50) nextSlide();
    if (endX - startX > 50) prevSlide();
  });

  /* RESIZE */
  window.addEventListener("resize", () => {
    setSlideWidth();
    track.style.transition = "none";
    track.style.transform = `translateX(-${slideWidth * index}px)`;
  });
});
